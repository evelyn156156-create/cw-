#!/bin/bash

# ä¸€é”®é‡éƒ¨ç½²è„šæœ¬
# ä½œç”¨ï¼šé‡æ–°ç¼–è¯‘å‰ç«¯ï¼Œå¹¶é‡å¯æœåŠ¡

echo "ğŸš€ å¼€å§‹ä¸€é”®é‡éƒ¨ç½²..."

# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd /root/crypto-intel-ai || { echo "âŒ æ‰¾ä¸åˆ°ç›®å½• /root/crypto-intel-ai"; exit 1; }

# 2. åœæ­¢æ—§æœåŠ¡
echo "ğŸ›‘ åœæ­¢æ—§æœåŠ¡..."
pm2 stop news-app 2>/dev/null
pm2 delete news-app 2>/dev/null

# 3. é‡æ–°å®‰è£…ä¾èµ– (é˜²æ­¢ä¾èµ–ç¼ºå¤±)
echo "ğŸ“¦ æ£€æŸ¥ä¾èµ–..."
npm install

# 4. é‡æ–°ç¼–è¯‘å‰ç«¯ (ç”Ÿæˆ dist æ–‡ä»¶å¤¹)
echo "ğŸ”¨ æ­£åœ¨ç¼–è¯‘å‰ç«¯ (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)..."
npm run build

# æ£€æŸ¥ç¼–è¯‘æ˜¯å¦æˆåŠŸ
if [ ! -d "dist" ]; then
  echo "âŒ ç¼–è¯‘å¤±è´¥ï¼æ²¡æœ‰ç”Ÿæˆ dist æ–‡ä»¶å¤¹ã€‚"
  exit 1
fi

# 5. å¯åŠ¨æœåŠ¡
echo "âœ… å¯åŠ¨æœåŠ¡..."
pm2 start npm --name "news-app" -- start

# 6. ä¿å­˜çŠ¶æ€
pm2 save

echo "=================================================="
echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
echo "è¯·è®¿é—®: http://$(curl -s ifconfig.me):3001"
echo "=================================================="
